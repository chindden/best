/**
 * Cloudflare Snippets Domains Query Bookmarklet
 * 浏览器书签脚本 - 一键查询Cloudflare Snippets域名
 * 
 * 使用方法:
 * 1. 在浏览器中新建书签
 * 2. URL 字段粘贴下方的代码
 * 3. 在Cloudflare Dashboard打开此书签即可执行
 */

javascript:(async()=>{try{let a=[],b=1,c=true;console.log("[*] Starting query...");for(;c;){const d=await fetch("/api/v1/zones?per_page=50&page="+b,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"}),e=await d.json();if(e.success&&e.result){a=a.concat(e.result),c=e.result_info&&e.result_info.page<e.result_info.total_pages,b++,console.log("Got "+a.length+" zones")}else{console.error("Failed to fetch zones:",e);throw new Error("Failed to fetch zones")}}console.log("Found "+a.length+" zones");let f=[],g=[],h=[];for(let i=0;i<a.length;i++){const j=a[i];try{const k=await fetch("/api/v1/zones/"+j.id+"/subscription",{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"}),l=await k.json();if(l.success&&l.result){const m=l.result.component_values||{};if(m.snippets!==undefined&&m.snippets>0){f.push({name:j.name,zoneId:j.id,snippets:m.snippets,status:j.status,plan:j.plan?j.plan.name:"Unknown"}),console.log("[OK] "+j.name+" has Snippets")}else{g.push({name:j.name,zoneId:j.id,plan:j.plan?j.plan.name:"Unknown"}),console.log("[X] "+j.name+" no Snippets")}}else{h.push({name:j.name,zoneId:j.id,error:l.errors?l.errors[0].message:"Unknown error"}),console.log("[!] "+j.name+" check failed")}}catch(n){h.push({name:j.name,zoneId:j.id,error:n.message}),console.warn("[!] "+j.name+" error: "+n.message)}await new Promise(o=>setTimeout(o,100))}console.log("Results: Enabled="+f.length+", Disabled="+g.length+", Errors="+h.length);if(f.length>0){console.log("Enabled domains:"),console.table(f)}if(g.length>0){console.log("Disabled domains:"),console.table(g)}if(h.length>0){console.log("Failed checks:"),console.table(h)}window.cfSnippetsResult={timestamp:new Date().toISOString(),summary:{total:a.length,snippetsEnabled:f.length,snippetsDisabled:g.length,errors:h.length},snippetsEnabledZones:f,snippetsDisabledZones:g,errorZones:h};console.log("Query completed! Results saved to cfSnippetsResult");return window.cfSnippetsResult}catch(v){console.error("Error:",v);throw v}})();
